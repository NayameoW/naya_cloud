# Python 3.9 中的 PEG 语法分析算法

## 0 题外话
若文章有后续更新，可以在[我的博客](https://www.cnblogs.com/nayameow/)上看到。
pre 视频在[这里](https://www.bilibili.com/video/BV1kT411o7Rv)。

## 1 PEG: Parsing Expression Grammar
### 1.1 定义
#### 1.1.1 语法
形式上，一个解析表达文法由以下部分组成：
- 一个有限的非终结符的集合 $N$
- 一个有限的终结符的集合 $\Sigma$，和 $N$ 没有交集
- 一个有限的解析规则的集合 $P$
- 一个被称作开始表达式的解析表达式 $e_s$

#### 1.1.2 语义
PEG 与 CFG 最关键的不同是，PEG 的选择操作符是有序的。如果第一个选项匹配成功，则忽略第二个（以及之后的）选项。因此 PEG 的有序选择是不可交换的。

### 1.2 解释
解析表达文法里每一个非终结符本质上表示递归下降解析器里面的一个解析函数，其对应的解析表达式展示了这个函数包含的代码内容。
从原理上来说，每一个解析函数接受一个输入字符串作为参数，返回其中一个结果：
- 成功，函数可能向前移动或者消耗一个或多个输入字符串的字符
- 失败，不消耗字符

**序列操作符** $e_1e_2$ 首先调用 $e_1$，如果 $e_1$ 成功，接着对 $e_1$ 消耗盛夏得输入字符串调用 $e_2$，最后返回结果。如果 $e_1$ 或者 $e_2$ 失败，那么序列表达式 $e_1e_2$ 失败。
**选择操作符** $e_1/e_2$ 首先调用 $e_1$，如果 $e_1$ 成功，立刻返回结果。否则如果 $e_1$ 失败，选择操作符回溯到输入字符串匹配 $e_1$ 的原始位置，调用 $e_2$，最后返回 $e_2$ 结果。
与上下文无关文法和正则表达式不同的是，在 PEG 里这些操作符总是执行贪婪的行为，那就是消耗尽可能多的输入，而且绝对不回溯。正则表达式一开始执行贪婪匹配，但是如果整个正则表达式失败后，会回退并尝试短一些的匹配。

### 1.3 解析器
#### 1.3.1 实现
所有的解析表达文法都能够被转化为递归下降解析器。由于 PEG 提供了理论上不受限制的向前检查能力，所以最终得到的解析器是可以避免最坏情况下指数级时间复杂度的。通过保存增量解析步骤的结果和确保每一个解析函数在同一个输入位置只被调用一次，就可以把任意解析表达文法转化成一个 `Packrat Parser`，可以实现线性时间复杂度解析，代价是占用大量的空间。

#### 1.3.2 细谈 Packrat Parser
`Packrat Parser` 是一种结构上类似递归下降解析器的语法解析器，区别是解析过程中，它记下所有互相递归调用的函数的中间结果。因为保存了这些信息，`Packrat Parser` 拥有以线性时间复杂度解析多数上下文无关文法和所有解析表达文法的能力。类似的东西让我想起蒋炎岩老师在 ICS 实验课上讲到过的汉诺塔问题，当时他展示了如何不用递归解决汉诺塔，用的就是直接对栈的操作。当然可能真实原理差了很多，但是同样是处理递归问题的一些小小的震撼，因此在这提一嘴。


## 2 PEG 与 LL (1) 的区别
### 2.1 预测 vs. 回溯
我们知道，Cpython 3.8 以前采用的都是一个叫 pgen 的分析器，它基于的是 LL (1) 分析算法。而 LL (1) 分析器是一种预测型分析器，即每次可以"预见"往后数 1 个的 token，来确定使用哪条规则展开。这个过程是在实际递归调用之前的，因此可以保证解析函数不会被重复调用，并且任意输入都能在线性时间内完成。那么既然有这么大的时间优势，LL (1) 算法必然也会存在一定的局限性。那就是它对文法的要求很高，即很多上下文无关文法是没有办法用 LL (1) 等预测型算法解析的。比如有不能含有左递归、必须"left-factoring"等限制条件。



## 3 PEG parser 给 Python 带来了什么
### 3.1 左递归

### 3.2 Grammar Actions


## 4 Reference

[Construction of LL(1) Parsing Table - GeeksforGeeks](https://www.geeksforgeeks.org/construction-of-ll1-parsing-table/)

[Packrat Parsing: a Practical Linear-Time Algorithm with Backtracking (mit.edu)](https://pdos.csail.mit.edu/~baford/packrat/thesis/)

[thesis.pdf (mit.edu)](https://pdos.csail.mit.edu/~baford/packrat/thesis/thesis.pdf)

[pepm08.pdf (ucla.edu)](http://web.cs.ucla.edu/~todd/research/pepm08.pdf)