处理器管理是操作系统的重要组成部分：
- 负责管理、调度和分配计算机系统的重要资源，并控制程序执行
- 处理器管理中最重要的是处理器调度，即进程调度，也就是控制、协调进程对处理器的竞争

进程与线程：
- 进程是资源分配和管理的单位
- 线程是处理器调度的基本单位

管态与目态：
- 管态又叫特权态，可以执行特权指令，执行资源管理程序、为应用程序执行提供良好运行环境的各种原语等
- 目态又叫用户态，只能执行非特权指令

# 1 处理器与寄存器
## 1.1 处理器
![](https://s2.loli.net/2022/12/01/bZQE7mJMzs8eAj5.png)

## 1.2 寄存器
**用户程序可见寄存器**
可以使程序员减少访问主存储器的次数，提高指令执行的效率
所有程序可使用，包括应用程序和系统程序
- 数据寄存器：又称通用寄存器
- 地址寄存器：索引、栈指针、段地址等寄存器

**控制与状态寄存器**
主要被具有特权的操作系统程序使用，以控制程序的执行
程序计数器PC：存储将取指令地址
指令寄存器IR：存储最近使用的指令
条件码CC：标志正/负/零/溢出等结果
标志位：中断位、中断允许位、中断屏蔽位、处理器模式位、内存保护位等

**程序状态字PSW**
PSW既是操作系统的概念，指记录当前程序运行的动态信息，也是计算机系统的寄存器（设置一组控制与状态寄存器，也可以专设一个PSW寄存器）
通常包含：
- 程序计数器、指令寄存器、条件码
- 中断字、中断允许/禁止、中断屏蔽、处理器模式、内存保护、调试控制

PSW in IBM System/360：
![](https://s2.loli.net/2022/12/01/tB45Qud8soxqIrU.png)


# 2 指令与处理器模式
## 2.1 机器指令
机器指令是计算机系统执行的基本命令，是中央处理器执行的基本单位

## 2.2 指令执行过程
一种指令执行步骤：
- 取指：根据PC从存储器或cache中取指令到IR
- 解码：解译IR中的指令来决定其执行行为
- 执行：连接到CPU部件，执行运算，产生结果并写回，同时在CC里设置运算结论标志；跳转指令操作PC，其他指令递增PC值

## 2.3 指令执行周期与指令流水线
![](https://s2.loli.net/2022/12/01/lLQxuC6DSa25myZ.png)

## 2.4 特权指令与非特权指令
特权指令：只能被操作系统内核使用的指令
非特权指令：能被所有程序使用的指令

## 2.5 处理器模式
计算机通过设置处理器模式实现特权指令管理
一般设置四种运行模式，分别对应：
- 0：操作系统内核
- 1：系统调用
- 2：共享库程序
- 3：用户程序等保护级别
> 0模式可以执行全部指令；3模式只能执行非特权指令；其他运行模式可以规定执行的指令子集
> 一般来说现代操作系统只使用0和3两种模式，分别对应内核模式和用户模式

## 2.6 处理器模式的切换
用户模式$\to$内核模式，内核模式$\to$用户模式
中断、异常或系统异常等事件导致用户程序向OS内核切换，触发用户模式$\to$内核模式
OS内核处理完成后，调用中断返回指令，触发内核模式$\to$用户模式


# 3 中断
## 3.1 中断的概念
中断是指程序执行过程中，遇到急需处理的事件时，暂时中止CPU上现行程序的运行，转去执行相应事件的处理程序，待处理完成后再返回源程序被中断处或调度其他程序执行的过程。
操作系统时“中断驱动”的；也就是说，中断时激活操作系统的唯一方式。
>上述中断指的是广义中断

## 3.2 中断、异常与系统异常
狭义的中断指来源于处理器之外的中断事件，即与当前运行指令无关的中断事件，如I/O中断、时钟中断、外部信号中断等
异常指当前运行指令引起的中断事件，如地址异常、算数异常、处理器硬件故障等
系统异常指陷入指令而触发系统调用引起的中断事件，如请求设备、请求I/O、创建进程等
>中断与异常的异同？
>相同点：
>都是程序执行过程中的强制性转移，转移到相应的处理程序。
>中断是CPU以外的事件引起的，而异常来自CPU内部事件或程序执行中的事件引起的过程。中断是异步的，异常是同步的。

## 3.3 中断源
由处理器、内存储器、总线等硬件故障引起
处理原则为：保护现场、停止设备、停止CPU、向操作员报告、等待人工干预
1 **程序性中断事件（内部异常中断）**：
处理器执行机器指令引起
- 除数为0、操作数溢出等算数异常
- 非法指令、用户态使用特权指令、地址越界、非法存取等指令异常
- 虚拟地址异常
2 **自愿性中断事件（软中断）**：
处理器执行陷入指令请求OS服务引起；在操作系统中一般被称作系统调用
处理流程：陷入OS、保护现场、根据功能号查入口地址、跳转具体处理程序
3 **I/O中断事件**：
来源于外围设备报告I/O状态的中断事件
4 **外部中断事件**：
由外围设备发出的信号引起的中断事件（时钟中断、间隔时间中断；设备报到与结束中断；键盘鼠标信号中断；关机/重启中断）


# 4 中断系统
中断系统是计算机系统中响应和处理中断的系统，包括硬件子系统和软件子系统两部分，分别进行响应与处理。
## 4.1 中断响应处理与指令执行周期
在指令执行周期最后增加一个微操作，以影响中断
![](https://s2.loli.net/2022/12/01/WLDZQF63ybGPcrO.png)

## 4.2 中断装置
指计算机系统中发现并响应中断/异常的硬件装置；由于中断源的多样性，硬件实现的中断装置有多种，分别处理不同类型的中断：
- 处理器外的中断
- 处理器内的异常
- 请求OS服务的系统异常

## 4.3 中断控制器
CPU中的一个控制部件，包括中断控制逻辑线路和中断寄存器
- 外部设备向其发出中断请求IRQ，在中断寄存器中设置已发生的中断
- 指令处理结束前，会检查中断寄存器，若有不被屏蔽的中断产生，则改变处理器内的操作顺序，引出操作系统中的中断处理程序

## 4.4 陷阱与系统陷阱
指令的逻辑和实现线路的一部分
- 执行指令出现异常后，会根据异常情况转向操作系统的异常处理程序
- 出现虚拟地址异常后，需要重新执行指令，往往越过陷阱独立设置页面异常处理程序
- 执行陷入指令后，越过陷阱处理，触发系统陷阱，激活系统调用处理程序

## 4.5 中断响应过程
1. 发现中断源，提出中断请求
	1. 发现中断寄存器中记录的中断
	2. 决定这些中断是否应该屏蔽
	3. 根据优先级选择一个中断源响应
2. 中断当前程序的执行（保存当前程序的PSW/PC到核心栈）
3. 转向操作系统的中断处理程序

## 4.6 中断的处理
中断处理程序：主要任务是处理中断事件和恢复正常操作
中断处理过程：
- 保护未被硬件保护的处理器状态
- 通过分析被中断进程的PSW中断码字段，识别中断源
- 分别处理发生的中断事件
- 恢复正常操作
	- 情况一：处理完毕后，直接返回刚刚被中断的进程
	- 情况二：需要中断当前进程的运行，调整进程队列，启动进程调度，选择下一个执行的进程并恢复其执行

![](https://s2.loli.net/2022/12/01/CocI3H2ZOkNjsal.png)



# 5 多中断的响应与处理
## 5.1 中断屏蔽
当计算机检测到中断时，中断装置通过中断屏蔽位决定是否响应已发生的中断。

## 5.2 中断优先级
当计算机同时检测到多个中断时，中断装置响应中断的顺序
一种可能的处理次序：
处理机硬件故障中断事件、自愿性中断事件、程序性中断事件、时钟中断等外部中断时间、输入输出中断事件、重启动和关机中断事件。

## 5.3 中断的嵌套处理
当计算机响应中断后，在中断处理过程中可以再响应其他中断。考虑到系统效率和实现代价，中断的嵌套应限制在一定层数内，如3层。

## 5.4 中断响应与处理总结
决定中断处理次序的因素：
- 中断屏蔽可以使中断装置不响应某些中断
- 中断优先级决定了中断装置响应中断的次序
- 中断可以嵌套处理，但嵌套的层数应有限制
- 中断的嵌套处理改变了中断处理的次序


# 6 进程及其状态
## 6.1 进程的提出
操作系统必须全方位地管理计算机系统中运行的程序，因此操作系统为正在运行程序建立一个管理实体——进程。

## 6.2 进程的概念
进程是一个具有一定独立功能的程序，是关于某个数据集合的一次运行活动；进程是操作系统进行资源分配和调度的一个独立单位。
一个进程包括五个实体部分：
- （OS管理运行程序的）数据结构P
- （运行程序的）内存代码C
- （运行程序的）内存数据D
- （运行程序的）通用寄存器
- （OS控制程序执行的）程序状态字信息PSW

## 6.3 进程举例
### 6.3.1 根据数据集
不同程序在不同数据集上运行：构成两个无关进程
不同程序在相同数据集上运行：构成两个共享数据的交往进程
### 6.3.2 根据代码
相同代码在不同数据集上运行：构成两个共享代码的无关进程
共享的代码称为可再入程序，如编辑器
可再入程序是纯代码的
### 6.3.3 内存级
前述的程序与数据集均是内存级的。
那么，在不同时段中针对同一个外存数据文件运行同一个外存程序文件，意味着完全不同的P/C/D/R/Psw，所以两次运行构成两个不同的进程。

## 6.4 概念级的进程状态
运行态：进程占有处理器运行
就绪态：进程具备运行条件等待处理器运行
等待态：进程由于等待资源、输入输出、信号等而不具备运行条件
### 6.4.1 进程三态模型
![](https://s2.loli.net/2022/12/07/B9SAvb8xCQD6lra.png)
### 6.4.2 进程挂起的概念
OS无法预期进程的数目与资源需求，计算机系统在运行过程中可能出现资源不足的情况。
解决办法：剥夺某些进程的内存及其资源，调入OS管理的对换区，不参加进程调度，待适当时候再调入内存、恢复资源、参与运行。这就是进程挂起。
> 挂起态与等待态有着本质区别，后者占有已申请到的资源处于等待，前者没有任何资源。

### 6.4.3 进程挂起的选择与恢复
加入挂起的概念后，进程的形态模型变得更加复杂。

![image.png](https://s2.loli.net/2023/01/16/Xl38pzqdkPcW95w.png)

一些规则：
- 一般选择等待态进程进入挂起等待态，也可以选择就绪态进程进入挂起就绪态
- 运行态进程可以挂起自己
- 等待事件结束后，挂起等待态进入挂起就绪态
- 一般选择挂起就绪态进程予以恢复


## 6.5 进程的数据描述


## 6.6 进程的管理


# 7 多线程技术概述


# 8 处理器调度
## 8.1 处理器调度的层次

## 8.2 处理器调度算法